<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bate-Papo - Chat</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Configura√ß√£o do Supabase (deve vir antes da biblioteca) -->
    <script>
        // Configura√ß√£o do Supabase
        const SUPABASE_URL = 'https://biotoafvuqgtlswlpjrt.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpb3RvYWZ2dXFndGxzd2xwanJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1OTExMjMsImV4cCI6MjA4NDE2NzEyM30.cUX-0lpYPNK4-KLpj5NUSeoA45ZouJBWFPtUbitLPTw';
        
        // Vari√°vel global para o cliente Supabase
        let supabaseClient = null;
        
        // Fun√ß√£o global para inicializar o Supabase
        window.initSupabaseClient = function() {
            try {
                // A biblioteca UMD pode expor de diferentes formas
                let SupabaseLib = null;
                
                // Tenta diferentes formas de acesso
                if (typeof supabaseLib !== 'undefined' && supabaseLib.createClient) {
                    SupabaseLib = supabaseLib;
                } else if (typeof window.supabaseLib !== 'undefined' && window.supabaseLib.createClient) {
                    SupabaseLib = window.supabaseLib;
                } else if (typeof window.supabase !== 'undefined' && window.supabase.createClient) {
                    // J√° est√° exposto como window.supabase
                    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    window.supabase = supabaseClient;
                    console.log('‚úÖ Supabase inicializado com sucesso (via window.supabase)');
                    return;
                }
                
                if (SupabaseLib && SupabaseLib.createClient) {
                    supabaseClient = SupabaseLib.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    window.supabase = supabaseClient; // Exp√µe globalmente
                    console.log('‚úÖ Supabase inicializado com sucesso');
                } else {
                    console.error('‚ùå Biblioteca do Supabase n√£o encontrada. Verifique o console para mais detalhes.');
                    console.log('Vari√°veis globais dispon√≠veis:', Object.keys(window).filter(k => k.toLowerCase().includes('supabase')));
                }
            } catch (error) {
                console.error('‚ùå Erro ao inicializar Supabase:', error);
            }
        };
    </script>
    <!-- Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" onload="initSupabaseClient()"></script>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <button class="menu-toggle-btn" id="menuToggleBtn" title="Menu">‚ò∞</button>
            <div class="header-info">
                <h1>üí¨ Bate-Papo</h1>
                <div class="user-info">
                    <span class="user-nickname" id="currentUserNickname"></span>
                    <span class="user-city" id="currentUserCity"></span>
                    <button class="edit-profile-btn" id="editProfileBtn" title="Editar perfil">‚úèÔ∏è</button>
                </div>
                <div class="chat-mode-indicator" id="chatModeIndicator">
                    <span id="chatModeText">Chat P√∫blico</span>
                    <button class="btn-back-public" id="backToPublicBtn" style="display: none;">Voltar ao P√∫blico</button>
                </div>
            </div>
            <button class="btn btn-secondary" id="logoutBtn">Sair</button>
        </div>

        <div class="chat-main">
            <div class="sidebar-overlay" id="sidebarOverlay"></div>
            <div class="users-sidebar" id="usersSidebar">
                <div class="sidebar-header">
                    <h3>üë• Usu√°rios Online</h3>
                    <span class="online-count-badge" id="onlineCountBadge">0</span>
                    <button class="sidebar-close-btn" id="sidebarCloseBtn" title="Fechar">‚úï</button>
                </div>
                <div class="users-list" id="usersList">
                    <!-- Lista de usu√°rios ser√° inserida aqui via JavaScript -->
                </div>
            </div>

            <div class="chat-content">
                <div class="chat-messages" id="chatMessages">
                    <!-- Mensagens ser√£o inseridas aqui via JavaScript -->
                </div>

                <div class="chat-input-container">
                    <div class="media-actions" id="mediaActions" style="display: none;">
                        <button type="button" class="media-btn" id="photoBtn" title="Enviar foto">
                            üì∑ Foto
                        </button>
                        <button type="button" class="media-btn" id="videoBtn" title="Enviar v√≠deo">
                            üé• V√≠deo
                        </button>
                        <button type="button" class="media-btn video-call-btn" id="videoCallBtn" title="V√≠deo chamada">
                            üìπ V√≠deo Chamada
                        </button>
                    </div>
                    <form id="messageForm" class="chat-input-form">
                        <input 
                            type="file" 
                            id="photoInput" 
                            accept="image/*"
                            style="display: none;"
                        >
                        <input 
                            type="file" 
                            id="videoInput" 
                            accept="video/*"
                            style="display: none;"
                        >
                        <input 
                            type="text" 
                            id="messageInput" 
                            placeholder="Digite sua mensagem..." 
                            autocomplete="off"
                            maxlength="500"
                        >
                        <button type="submit" class="btn btn-primary">Enviar</button>
                    </form>
                </div>
                
                <!-- Modal de V√≠deo Chamada -->
                <div class="video-call-modal" id="videoCallModal" style="display: none;">
                    <div class="video-call-content">
                        <div class="video-call-header">
                            <h3>üìπ V√≠deo Chamada</h3>
                            <button class="close-video-call" id="closeVideoCall">‚úï</button>
                        </div>
                        <div class="video-call-body">
                            <div class="video-container">
                                <video id="localVideo" autoplay muted></video>
                                <video id="remoteVideo" autoplay></video>
                            </div>
                            <div class="video-call-controls">
                                <button class="video-control-btn" id="toggleVideo">üìπ</button>
                                <button class="video-control-btn" id="toggleAudio">üé§</button>
                                <button class="video-control-btn end-call" id="endCall">üìû</button>
                            </div>
                            <p class="video-call-status" id="videoCallStatus">Conectando...</p>
                        </div>
                    </div>
                </div>

                <!-- Modal de Notifica√ß√£o de V√≠deo Chamada -->
                <div class="video-call-invite-modal" id="videoCallInviteModal" style="display: none;">
                    <div class="video-call-invite-content">
                        <div class="video-call-invite-header">
                            <h3>üìπ V√≠deo Chamada Recebida</h3>
                        </div>
                        <div class="video-call-invite-body">
                            <div class="caller-info">
                                <div class="caller-avatar">üìπ</div>
                                <div class="caller-details">
                                    <p class="caller-name" id="callerName">Usu√°rio</p>
                                    <p class="caller-city" id="callerCity">Cidade</p>
                                </div>
                            </div>
                            <p class="invite-message">est√° chamando voc√™ para uma v√≠deo chamada</p>
                            <div class="invite-actions">
                                <button class="btn-accept-call" id="acceptCallBtn">‚úÖ Aceitar</button>
                                <button class="btn-reject-call" id="rejectCallBtn">‚ùå Recusar</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Edi√ß√£o de Perfil -->
    <div class="edit-profile-modal" id="editProfileModal" style="display: none;">
        <div class="edit-profile-content">
            <div class="edit-profile-header">
                <h3>‚úèÔ∏è Editar Perfil</h3>
                <button class="close-edit-profile" id="closeEditProfile">‚úï</button>
            </div>
            <form id="editProfileForm" class="edit-profile-form">
                <div class="form-group">
                    <label for="editNickname">Apelido</label>
                    <input type="text" id="editNickname" required placeholder="Seu apelido">
                </div>
                <div class="form-group">
                    <label for="editEmail">E-mail</label>
                    <input type="email" id="editEmail" required placeholder="seu@email.com">
                </div>
                <div class="form-group">
                    <label for="editCity">Cidade</label>
                    <select id="editCity" required>
                        <option value="">Selecione sua cidade</option>
                        <option value="S√£o Paulo">S√£o Paulo</option>
                        <option value="Guarulhos">Guarulhos</option>
                        <option value="Campinas">Campinas</option>
                        <option value="S√£o Bernardo do Campo">S√£o Bernardo do Campo</option>
                        <option value="Santo Andr√©">Santo Andr√©</option>
                        <option value="Osasco">Osasco</option>
                        <option value="Ribeir√£o Preto">Ribeir√£o Preto</option>
                        <option value="Sorocaba">Sorocaba</option>
                        <option value="Mau√°">Mau√°</option>
                        <option value="S√£o Jos√© dos Campos">S√£o Jos√© dos Campos</option>
                        <option value="Mogi das Cruzes">Mogi das Cruzes</option>
                        <option value="Santos">Santos</option>
                        <option value="Diadema">Diadema</option>
                        <option value="Jundia√≠">Jundia√≠</option>
                        <option value="Piracicaba">Piracicaba</option>
                        <option value="Carapicu√≠ba">Carapicu√≠ba</option>
                        <option value="Bauru">Bauru</option>
                        <option value="Itaquaquecetuba">Itaquaquecetuba</option>
                        <option value="S√£o Vicente">S√£o Vicente</option>
                        <option value="Franca">Franca</option>
                        <option value="Praia Grande">Praia Grande</option>
                        <option value="Guaruj√°">Guaruj√°</option>
                        <option value="Taubat√©">Taubat√©</option>
                        <option value="Limeira">Limeira</option>
                        <option value="Suzano">Suzano</option>
                        <option value="Barueri">Barueri</option>
                        <option value="Tabo√£o da Serra">Tabo√£o da Serra</option>
                        <option value="Sumar√©">Sumar√©</option>
                        <option value="Embu das Artes">Embu das Artes</option>
                        <option value="S√£o Caetano do Sul">S√£o Caetano do Sul</option>
                        <option value="Americana">Americana</option>
                        <option value="Araraquara">Araraquara</option>
                        <option value="Indaiatuba">Indaiatuba</option>
                        <option value="Cotia">Cotia</option>
                        <option value="S√£o Jos√© do Rio Preto">S√£o Jos√© do Rio Preto</option>
                        <option value="Jacare√≠">Jacare√≠</option>
                        <option value="Hortol√¢ndia">Hortol√¢ndia</option>
                        <option value="Rio Claro">Rio Claro</option>
                        <option value="Ara√ßatuba">Ara√ßatuba</option>
                        <option value="Santa B√°rbara d'Oeste">Santa B√°rbara d'Oeste</option>
                        <option value="Ferraz de Vasconcelos">Ferraz de Vasconcelos</option>
                        <option value="Francisco Morato">Francisco Morato</option>
                        <option value="Itapecerica da Serra">Itapecerica da Serra</option>
                        <option value="Itu">Itu</option>
                        <option value="Bragan√ßa Paulista">Bragan√ßa Paulista</option>
                        <option value="Pindamonhangaba">Pindamonhangaba</option>
                        <option value="Itapetininga">Itapetininga</option>
                        <option value="S√£o Carlos">S√£o Carlos</option>
                        <option value="Caieiras">Caieiras</option>
                        <option value="Mogi Gua√ßu">Mogi Gua√ßu</option>
                        <option value="Franco da Rocha">Franco da Rocha</option>
                        <option value="Mar√≠lia">Mar√≠lia</option>
                        <option value="Presidente Prudente">Presidente Prudente</option>
                        <option value="Botucatu">Botucatu</option>
                        <option value="Ja√∫">Ja√∫</option>
                        <option value="Atibaia">Atibaia</option>
                        <option value="Sert√£ozinho">Sert√£ozinho</option>
                        <option value="Barretos">Barretos</option>
                        <option value="Valinhos">Valinhos</option>
                        <option value="Votorantim">Votorantim</option>
                        <option value="Tatu√≠">Tatu√≠</option>
                        <option value="V√°rzea Paulista">V√°rzea Paulista</option>
                        <option value="Birigui">Birigui</option>
                        <option value="Salto">Salto</option>
                        <option value="Caraguatatuba">Caraguatatuba</option>
                        <option value="Catanduva">Catanduva</option>
                        <option value="Leme">Leme</option>
                        <option value="Assis">Assis</option>
                        <option value="Itatiba">Itatiba</option>
                        <option value="Ourinhos">Ourinhos</option>
                        <option value="Avar√©">Avar√©</option>
                        <option value="Mogi Mirim">Mogi Mirim</option>
                        <option value="Tup√£">Tup√£</option>
                        <option value="Jaboticabal">Jaboticabal</option>
                        <option value="Lins">Lins</option>
                        <option value="Votuporanga">Votuporanga</option>
                        <option value="Registro">Registro</option>
                        <option value="S√£o Roque">S√£o Roque</option>
                        <option value="Itapira">Itapira</option>
                        <option value="Pen√°polis">Pen√°polis</option>
                        <option value="Batatais">Batatais</option>
                        <option value="Aruj√°">Aruj√°</option>
                        <option value="Mairipor√£">Mairipor√£</option>
                        <option value="Cubat√£o">Cubat√£o</option>
                        <option value="Santo Ant√¥nio de Posse">Santo Ant√¥nio de Posse</option>
                        <option value="Po√°">Po√°</option>
                        <option value="S√£o Sebasti√£o">S√£o Sebasti√£o</option>
                        <option value="Vinhedo">Vinhedo</option>
                        <option value="Jaguari√∫na">Jaguari√∫na</option>
                        <option value="Paul√≠nia">Paul√≠nia</option>
                        <option value="Mongagu√°">Mongagu√°</option>
                        <option value="Itanha√©m">Itanha√©m</option>
                        <option value="Peru√≠be">Peru√≠be</option>
                        <option value="Ubatuba">Ubatuba</option>
                        <option value="Ilhabela">Ilhabela</option>
                        <option value="Campos do Jord√£o">Campos do Jord√£o</option>
                        <option value="Guararema">Guararema</option>
                        <option value="Sales√≥polis">Sales√≥polis</option>
                        <option value="Biritiba Mirim">Biritiba Mirim</option>
                        <option value="Santa Isabel">Santa Isabel</option>
                        <option value="Bertioga">Bertioga</option>
                        <option value="Outra">Outra</option>
                    </select>
                </div>
                <div id="editProfileError" class="error-message"></div>
                <div class="edit-profile-actions">
                    <button type="button" class="btn btn-secondary" id="cancelEditProfile">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Altera√ß√µes</button>
                </div>
            </form>
        </div>
    </div>

    <script src="supabase-config.js"></script>
    <script src="supabase-service.js"></script>
    <script src="script.js"></script>
    <script src="chat.js"></script>
</body>
</html>
